# 🚀 自动化数据导入 - 完整指南

> **目标**: 通过命令行一键导入所有数据，无需手动操作 HBuilderX

---

## 📋 方案说明

使用 HTTP 云函数 + Node.js 脚本，实现完全自动化的数据导入。

**优势**:
- ✅ 完全自动化，一行命令搞定
- ✅ 自动分批导入大数据
- ✅ 实时显示进度
- ✅ 失败自动重试

---

## 🎯 操作步骤（只需 3 步）

### 步骤 1: 上传 HTTP 云函数（1次操作）

**在 HBuilderX 中**:
1. 找到云函数：`uniCloud-aliyun/cloudfunctions/data-import-http`
2. **右键** → **上传云函数**
3. 等待上传成功

### 步骤 2: 获取云函数 URL（1次操作）

**在 HBuilderX 中**:
1. 右键 `data-import-http` → **云函数/云对象运行**
2. 在弹出的对话框底部，找到 **"云函数URL"** 或类似字段
3. **复制这个 URL**

**或者在 Web 控制台**:
1. 打开 uniCloud Web 控制台
2. 云函数 → data-import-http → 详情
3. 找到 "云函数URL化" 部分
4. 复制 URL（类似：`https://xxxxxxx.bspapp.com/http/data-import-http`）

### 步骤 3: 配置并运行自动导入

**在命令行中（PowerShell）**:

```powershell
# 1. 进入 scripts 目录
cd tangzai-uniapp\scripts

# 2. 编辑 auto-import.js 文件
# 将第 11 行的 YOUR_CLOUD_FUNCTION_URL_HERE 替换为刚才复制的 URL
notepad auto-import.js

# 3. 运行自动导入
npm run auto-import
```

---

## 📝 详细说明：编辑 auto-import.js

打开 `scripts/auto-import.js` 文件，找到第 11 行：

```javascript
const CLOUD_FUNCTION_URL = 'YOUR_CLOUD_FUNCTION_URL_HERE';  // 需要替换
```

替换为你的云函数 URL：

```javascript
const CLOUD_FUNCTION_URL = 'https://xxxxxxx.bspapp.com/http/data-import-http';
```

**保存文件** 后运行 `npm run auto-import`

---

## 🎬 运行效果

运行 `npm run auto-import` 后，你会看到类似这样的输出：

```
🚀 开始自动化数据导入...

📡 云函数地址: https://xxxxxxx.bspapp.com/http/data-import-http

==========================================

📦 导入 cities (11 条数据)...
   ✅ 成功: 11 条

📦 导入 departments (9 条数据)...
   ✅ 成功: 9 条

📦 导入 models (5 条数据)...
   ✅ 成功: 5 条

📦 导入 uni-id-users (134 条数据)...
   分为 3 个批次导入
   批次 1/3: 50 条...
   ✅ 成功: 50 条
   批次 2/3: 50 条...
   ✅ 成功: 50 条
   批次 3/3: 34 条...
   ✅ 成功: 34 条

📦 导入 agents (4 条数据)...
   ✅ 成功: 4 条

📦 导入 web-cards (38 条数据)...
   分为 2 个批次导入
   批次 1/2: 20 条...
   ✅ 成功: 20 条
   批次 2/2: 18 条...
   ✅ 成功: 18 条

📦 导入 feishu-cards (12 条数据)...
   分为 2 个批次导入
   批次 1/2: 10 条...
   ✅ 成功: 10 条
   批次 2/2: 2 条...
   ✅ 成功: 2 条

==========================================

🎉 导入完成！
   成功: 7 个表
   失败: 0 个表
   总计: 7 个表
```

---

## ⚙️ 技术细节

### 导入顺序（已优化）

脚本会按照依赖关系自动导入：
1. cities（城市）- 基础数据
2. departments（部门）- 基础数据
3. models（AI模型）- 基础数据
4. uni-id-users（用户）- 依赖 cities, departments
5. agents（智能体）- 依赖 models
6. web-cards（网页卡片）- 依赖 cities, departments
7. feishu-cards（飞书卡片）- 依赖 cities, departments

### 自动分批

- users: 50条/批（共3批）
- web-cards: 20条/批（共2批）
- feishu-cards: 10条/批（共2批）
- 其他表：一次性导入

### 安全令牌

脚本使用简单的访问令牌 `tangzai-import-2025` 防止未授权访问。

---

## 🔍 验证导入结果

导入完成后，在 uniCloud Web 控制台验证：

```
云数据库 → 数据库集合管理

✅ cities        : 11 条
✅ departments   : 9 条
✅ models        : 5 条
✅ uni-id-users  : 134 条
✅ agents        : 4 条
✅ web-cards     : 38 条
✅ feishu-cards  : 12 条

总计：213 条记录
```

---

## 🐛 常见问题

### Q1: 找不到云函数 URL？
**A**: 
- 确保已上传 `data-import-http` 云函数
- 在 HBuilderX 中右键云函数 → 查看详情
- 或在 Web 控制台查看云函数详情

### Q2: 提示"无效的访问令牌"？
**A**: 
- 检查 `auto-import.js` 中的 `IMPORT_TOKEN` 是否正确
- 检查云函数 `data-import-http/index.js` 中的令牌是否一致

### Q3: 导入失败？
**A**: 
- 查看错误信息
- 确认数据库集合已创建且 Schema 已上传
- 确认网络连接正常

### Q4: 如何重新导入？
**A**: 
- 直接再次运行 `npm run auto-import`
- 脚本会自动清空旧数据并重新导入

---

## 📦 文件清单

```
tangzai-uniapp/
├── uniCloud-aliyun/cloudfunctions/
│   └── data-import-http/          # HTTP 云函数
│       ├── index.js               # 云函数代码
│       └── package.json           # 云函数配置
│
├── scripts/
│   ├── auto-import.js             # 自动导入脚本 ⭐
│   ├── export-mysql-data.js       # 数据导出脚本
│   └── package.json               # npm 脚本配置
│
├── data-export/                   # 导出的数据文件
│   ├── users.json
│   ├── agents.json
│   └── ...
│
└── 自动化导入完整指南.md          # 本文档
```

---

## 🎉 总结

### 传统方式（手动）
- ❌ 需要在 HBuilderX 中手动操作 11 次
- ❌ 需要逐个复制粘贴参数
- ❌ 容易出错

### 自动化方式（推荐）
- ✅ 只需运行一次命令
- ✅ 自动按顺序导入所有表
- ✅ 自动分批处理大数据
- ✅ 实时显示进度

---

**现在就开始自动化导入吧！** 🚀
