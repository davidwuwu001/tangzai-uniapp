# ✅ MySQL → MongoDB 数据迁移完成指南

## 📊 当前状态

✅ **已完成的步骤：**
1. ✅ 从MySQL导出 **133条** 用户数据
2. ✅ 数据格式转换完成（MySQL → MongoDB）
3. ✅ 数据保存到：`users-data.json`
4. ✅ 云函数 `import-users` 已上传到阿里云
5. ✅ 导入页面已创建：`pages/import-data/import-data.vue`

---

## 🚀 最后一步：导入数据到MongoDB

### 方式一：通过应用页面导入（推荐）

1. **在HBuilderX运行项目**
   ```
   运行 → 运行到浏览器 → Chrome
   ```

2. **访问导入页面**
   - 在浏览器地址栏输入：
   ```
   http://localhost:8080/#/pages/import-data/import-data
   ```
   - 或者修改 `pages.json` 将导入页面设为首页

3. **点击"去重导入"按钮**
   - 推荐使用"去重导入"，会自动跳过已存在的手机号
   - 如果确定数据库为空，也可以使用"开始导入"

4. **等待导入完成**
   - 页面会显示实时日志
   - 导入成功后会显示统计信息

---

### 方式二：通过uniCloud控制台导入

1. **登录控制台**
   - 访问：https://unicloud.dcloud.net.cn
   - 选择您的服务空间

2. **进入数据库**
   - 点击「云数据库」
   - 选择 `uni-id-users` 表

3. **导入JSON文件**
   - 点击「导入」按钮
   - 上传文件：`users-data.json`（本目录下）
   - 选择「插入新记录」模式
   - 点击「开始导入」

---

## 📋 导入后验证

### 1. 检查数据量
登录后访问导入页面，查看"用户总数"

### 2. 测试登录
使用导入的用户账号测试登录：
- 手机号：从 `users-data.json` 查看
- 密码：原MySQL数据库的密码

### 3. 查看云端数据
在uniCloud控制台查看 `uni-id-users` 表数据

---

## 📁 文件说明

```
scripts/
├── migrate-users-from-mysql.js    # MySQL导出脚本
├── package.json                    # 依赖配置
├── README.md                       # 详细使用指南
└── migration-output/
    ├── users-data.json             # 导出的用户数据（133条）
    ├── IMPORT_INSTRUCTIONS.txt     # 导入说明
    └── 完成指南.md                 # 本文件
```

---

## 🔧 云函数方法

### import-users 云对象提供以下方法：

#### 1. `checkExisting()`
查询当前用户数量
```javascript
const importUsersObj = uniCloud.importObject('import-users');
const result = await importUsersObj.checkExisting();
// { success: true, total: 133, recentUsers: [...] }
```

#### 2. `importWithDedupe(users)`
去重导入（推荐）
```javascript
const result = await importUsersObj.importWithDedupe(usersData);
// { total: 133, existing: 0, imported: 133 }
```

#### 3. `batchImport(users)`
批量导入（不检查重复）
```javascript
const result = await importUsersObj.batchImport(usersData);
// { total: 133, successCount: 133, errorCount: 0 }
```

#### 4. `clearAll(confirmCode)`
清空表（⚠️ 危险操作）
```javascript
const result = await importUsersObj.clearAll('CONFIRM_DELETE_ALL');
```

---

## 📝 数据示例

导出的用户数据格式：
```json
{
  "username": "吴世健",
  "mobile": "18240413895",
  "mobile_confirmed": 0,
  "password": "$2a$10$5UE5qW.7qleLb5a88JcqjuI22jsVFReqO6BVDGMd00t9MOq5mcYKS",
  "nickname": "吴世健",
  "city": "218",
  "department": "AI效率部",
  "is_admin": false,
  "role": ["user"],
  "permission": [],
  "register_date": "2025-08-23T16:02:27.000Z",
  "last_login_date": "2025-11-13T02:50:00.000Z",
  "token": []
}
```

---

## ⚠️ 注意事项

1. **密码安全**：密码已加密，直接复制保持原格式
2. **数据备份**：建议先备份现有MongoDB数据
3. **去重逻辑**：基于手机号（mobile）去重
4. **分批导入**：自动分批，每批50条，避免超时
5. **必填字段**：username 是必填字段

---

## 🎯 下一步建议

1. ✅ 导入数据到MongoDB
2. ✅ 验证用户登录功能
3. ✅ 检查数据完整性
4. 🗑️ 清理临时文件（可选）

---

## 📞 遇到问题？

### 常见问题：

**Q: 导入时提示"username字段缺失"**
A: 检查 `users-data.json` 中是否所有记录都有 username 字段

**Q: 手机号重复**
A: 使用"去重导入"功能，会自动跳过已存在的手机号

**Q: 云函数超时**
A: 数据会自动分批导入，每批50条。如果仍超时，减少batchSize值

**Q: 密码无法登录**
A: 确认密码加密方式与原系统一致（当前使用bcrypt）

---

**迁移完成后，这个目录可以保留作为备份，或者删除以节省空间。**

🎉 祝迁移顺利！
