<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ‰¹é‡å¯¼å…¥ç”¨æˆ·æ•°æ®</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #667eea;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #5568d3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
    .log-item {
      margin: 5px 0;
      padding: 3px 0;
    }
    .success { color: #52c41a; }
    .error { color: #f5222d; }
    .info { color: #666; }
    .progress {
      background: #e0e0e0;
      border-radius: 10px;
      height: 30px;
      margin: 20px 0;
      position: relative;
      overflow: hidden;
    }
    .progress-bar {
      background: linear-gradient(90deg, #667eea, #764ba2);
      height: 100%;
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ æ‰¹é‡å¯¼å…¥ç”¨æˆ·æ•°æ®</h1>
    
    <div>
      <p><strong>æ•°æ®æ–‡ä»¶ï¼š</strong> migration-output/users-data-final.json</p>
      <p><strong>æ€»æ•°ï¼š</strong> <span id="totalCount">-</span> æ¡</p>
    </div>
    
    <div class="progress">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>
    
    <div>
      <button id="loadBtn" onclick="loadData()">1. åŠ è½½æ•°æ®</button>
      <button id="importBtn" onclick="startImport()" disabled>2. å¼€å§‹å¯¼å…¥</button>
      <button id="checkBtn" onclick="checkExisting()">æŸ¥çœ‹å½“å‰æ•°é‡</button>
    </div>
    
    <div class="log" id="log"></div>
  </div>

  <script>
    let usersData = [];
    
    function addLog(message, type = 'info') {
      const log = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const item = document.createElement('div');
      item.className = `log-item ${type}`;
      item.textContent = `[${time}] ${message}`;
      log.appendChild(item);
      log.scrollTop = log.scrollHeight;
    }
    
    function updateProgress(current, total) {
      const percent = Math.round((current / total) * 100);
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = percent + '%';
      progressBar.textContent = `${current}/${total} (${percent}%)`;
    }
    
    async function loadData() {
      addLog('æ­£åœ¨åŠ è½½æ•°æ®...', 'info');
      try {
        const response = await fetch('./migration-output/users-data-final.json');
        usersData = await response.json();
        
        document.getElementById('totalCount').textContent = usersData.length;
        document.getElementById('importBtn').disabled = false;
        
        addLog(`âœ… åŠ è½½æˆåŠŸï¼š${usersData.length} æ¡è®°å½•`, 'success');
      } catch (e) {
        addLog(`âŒ åŠ è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    }
    
    async function checkExisting() {
      addLog('æŸ¥è¯¢å½“å‰æ•°æ®...', 'info');
      try {
        const importUsersObj = uniCloud.importObject('import-users');
        const result = await importUsersObj.checkExisting();
        
        if (result.success) {
          addLog(`âœ… å½“å‰æ•°æ®åº“æœ‰ ${result.total} æ¡ç”¨æˆ·è®°å½•`, 'success');
        } else {
          addLog(`âŒ æŸ¥è¯¢å¤±è´¥ï¼š${result.message}`, 'error');
        }
      } catch (e) {
        addLog(`âŒ æŸ¥è¯¢å¤±è´¥ï¼š${e.message}`, 'error');
      }
    }
    
    async function startImport() {
      if (usersData.length === 0) {
        addLog('âŒ è¯·å…ˆåŠ è½½æ•°æ®', 'error');
        return;
      }
      
      const confirm = window.confirm(`ç¡®å®šè¦å¯¼å…¥ ${usersData.length} æ¡ç”¨æˆ·æ•°æ®å—ï¼Ÿ`);
      if (!confirm) return;
      
      document.getElementById('importBtn').disabled = true;
      document.getElementById('loadBtn').disabled = true;
      
      addLog(`å¼€å§‹å¯¼å…¥ ${usersData.length} æ¡æ•°æ®...`, 'info');
      updateProgress(0, usersData.length);
      
      try {
        const importUsersObj = uniCloud.importObject('import-users');
        
        // ä½¿ç”¨å»é‡å¯¼å…¥
        const result = await importUsersObj.importWithDedupe(usersData);
        
        updateProgress(result.imported || 0, usersData.length);
        
        if (result.success) {
          addLog(`âœ… ${result.message}`, 'success');
          addLog(`æ€»æ•°ï¼š${result.total}ï¼Œå·²å­˜åœ¨ï¼š${result.existing}ï¼Œæ–°å¯¼å…¥ï¼š${result.imported}`, 'info');
        } else {
          addLog(`âŒ ${result.message}`, 'error');
        }
        
        // æŸ¥çœ‹æœ€ç»ˆç»“æœ
        await checkExisting();
        
      } catch (e) {
        addLog(`âŒ å¯¼å…¥å¤±è´¥ï¼š${e.message}`, 'error');
      } finally {
        document.getElementById('importBtn').disabled = false;
        document.getElementById('loadBtn').disabled = false;
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆ
    window.onload = () => {
      addLog('é¡µé¢åŠ è½½å®Œæˆ', 'info');
      addLog('è¯·å…ˆç‚¹å‡»"1. åŠ è½½æ•°æ®"æŒ‰é’®', 'info');
    };
  </script>
  
  <!-- å¼•å…¥ uniCloud SDK -->
  <script src="https://unpkg.com/@dcloudio/uni-cloud-router@latest/dist/index.js"></script>
</body>
</html>
